# HttpRun Java 项目发展规划

> 文档更新日期：2026年2月6日

## 📊 当前项目状态

### 已实现的核心功能

| 功能模块 | 状态 | 说明 |
|--------|------|------|
| 命令管理 | ✅ 已完成 | 创建、更新、删除、查询命令配置 |
| Token 认证 | ✅ 已完成 | 基于 JWT 的 API 访问控制，支持按命令授权和时间范围限制 |
| 本地执行 | ✅ 已完成 | 在服务器本地执行 Shell 命令 |
| SSH 远程执行 | ✅ 已完成 | 通过 SSH 在远程服务器执行命令 |
| SSH 凭证加密 | ✅ 已完成 | AES-GCM 256位加密存储密码和私钥 |
| SSH 三级认证 | ✅ 已完成 | 指定私钥 > 系统默认密钥 > 密码认证 |
| 参数模板 | ✅ 已完成 | 支持 `{{.variable}}` 模板语法 |
| 访问日志 | ✅ 已完成 | 完整的命令执行日志记录，智能过滤查询请求 |
| 执行历史 | ✅ 已完成 | 服务端分页存储，支持多维度筛选和管理 |
| Web 管理界面 | ✅ 已完成 | React + Ant Design Pro 前端 |
| 实时输出 | ✅ 已完成 | WebSocket 实时推送命令执行输出 |
| IP 白名单 | ✅ 已完成 | 限制命令只能从特定 IP 执行 |
| 命令注入防护 | ✅ 已完成 | 防止命令注入攻击，参数安全校验 |
| 命令收藏 | ✅ 已完成 | 收藏常用命令，快速访问 |
| 暗黑模式 | ✅ 已完成 | 前端主题切换 |

### 技术栈

**后端：**
- Java 17 (LTS)
- Spring Boot 3.2.x
- Spring Security 6.x + JWT
- Spring Data JPA + Hibernate
- 支持 SQLite / MySQL / H2 数据库
- Flyway 数据库迁移
- Micrometer + Prometheus 监控

**前端：**
- React 19 + TypeScript
- Ant Design 6 + Ant Design Pro + UmiJS
- Monaco Editor（代码编辑器）

**运维：**
- Docker 多阶段构建 + docker-compose
- Prometheus + Grafana 可观测性

---

## 🚀 短期优化（1-2个月）

> 聚焦性能提升、易用性改进和工程规范，以较低成本获取最大收益。

### 1. SSH 连接池与性能优化

**现状问题：** 当前每次 SSH 命令执行都新建 JSch Session，频繁连接同一台服务器时开销大、延迟高。

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| 🔴 高 | SSH 连接池 | 复用 SSH Session，减少连接建立开销（Apache Commons Pool2） | 3天 | ✅ 已完成 |
| 🔴 高 | 连接健康检查 | 连接池中 Session 定期心跳检测，自动剔除失效连接 | 1天 | ✅ 已完成 |
| 🟡 中 | SSH 指纹管理 | 首次连接记录主机指纹，后续连接自动验证（防中间人攻击） | 2天 | ✅ 已完成 |
| 🟡 中 | 连接超时优化 | 区分连接超时 / 执行超时，支持独立配置 | 1天 | ✅ 已完成 |

### 2. 命令管理增强

**现状问题：** 缺少批量操作、分组分类、导入导出等企业级命令管理功能。

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| 🔴 高 | 命令分组/标签 | 支持按业务、环境、用途等维度对命令打标签和分组 | 2天 | ⏳ 待开发 |
| 🔴 高 | 命令导入/导出 | JSON/YAML 格式批量导入导出命令配置，便于环境迁移 | 2天 | ⏳ 待开发 |
| 🟡 中 | 命令版本管理 | 记录命令配置变更历史，支持回滚到历史版本 | 3天 | ⏳ 待开发 |
| 🟡 中 | 命令克隆 | 一键复制现有命令创建新命令 | 0.5天 | ⏳ 待开发 |
| 🟢 低 | 命令描述 Markdown | 命令说明字段支持 Markdown 富文本 | 1天 | ⏳ 待开发 |

### 3. 通知与回调

**现状问题：** 命令执行结果无外部通知机制，无法与企业IM或CI/CD系统集成。

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| 🔴 高 | Webhook 回调 | 命令执行完成后回调指定URL（支持自定义Header/Body模板） | 2天 | ⏳ 待开发 |
| 🟡 中 | 钉钉/企业微信通知 | 内置钉钉机器人和企业微信推送命令执行结果 | 2天 | ⏳ 待开发 |
| 🟡 中 | 邮件通知 | 执行失败时邮件告警（Spring Mail） | 1天 | ⏳ 待开发 |
| 🟢 低 | 通知规则配置 | 按命令/状态/执行人等条件配置通知策略 | 2天 | ⏳ 待开发 |

### 4. 工程质量提升

**现状问题：** 当前有 8 个测试类，缺少 Controller 层集成测试和前端测试；缺乏事件驱动解耦。

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| 🔴 高 | 集成测试补充 | 补充 Controller 层集成测试、SSH 执行器 Mock 测试 | 3天 | ⏳ 待开发 |
| 🔴 高 | Spring Events 解耦 | 引入事件驱动架构，解耦命令执行/日志/通知等模块 | 2天 | ⏳ 待开发 |
| 🟡 中 | API 版本管理 | 引入 `/api/v1/` 路径前缀，为后续 API 演进预留空间 | 1天 | ⏳ 待开发 |
| 🟡 中 | 优雅停机 | 停机前等待正在执行的命令完成，避免命令中断 | 1天 | ⏳ 待开发 |
| 🟢 低 | 前端单元测试 | 补充核心组件（Executor、CodeSnippet）的 Jest 测试 | 3天 | ⏳ 待开发 |

---

## 📈 中期功能规划（3-6个月）

> 面向企业运维场景，补齐命令编排、定时任务、审批流程等关键能力。

### 1. 命令编排

**场景：** 部署时需要按顺序执行多个命令（停服务 → 备份 → 部署 → 启动）

**功能设计：**
```yaml
# 命令编排示例
name: deploy-app
steps:
  - command: stop-service
    on_failure: abort
  
  - command: backup-db
    params:
      backup_name: "{{.date}}-backup"
  
  - command: deploy-code
  
  - command: start-service
    on_failure: rollback_to: backup-db
```

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| 🔴 高 | 串行命令链 | 按顺序依次执行多个命令 | 3天 | ⏳ 待开发 |
| 🔴 高 | 失败策略 | 支持中止/继续/跳过/回滚策略 | 2天 | ⏳ 待开发 |
| 🟡 中 | 命令间参数传递 | 上一步的输出可作为下一步的输入参数 | 2天 | ⏳ 待开发 |
| 🟡 中 | 并行执行 | 支持简单的并行执行场景（如同时停多个服务） | 2天 | ⏳ 待开发 |
| 🟡 中 | 执行进度展示 | WebSocket 实时推送编排执行进度和各步骤状态 | 2天 | ⏳ 待开发 |
| 🟢 低 | 可视化编排 | 前端流程图编辑器，拖拽编排命令（参考 n8n） | 5天 | ⏳ 待开发 |

### 2. 定时任务

**场景：** 定期执行备份、巡检、清理等运维命令

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| 🔴 高 | Cron 定时执行 | 基于 Cron 表达式的定时命令执行 | 3天 | ⏳ 待开发 |
| 🔴 高 | 任务执行历史 | 记录定时任务的执行结果和耗时 | 1天 | ⏳ 待开发 |
| 🟡 中 | 可视化 Cron 编辑器 | 前端 Cron 表达式辅助编辑组件 | 2天 | ⏳ 待开发 |
| 🟡 中 | 失败重试与告警 | 失败后自动重试 N 次，超限触发告警通知 | 2天 | ⏳ 待开发 |
| 🟢 低 | 手动触发 | 定时任务支持手动立即触发执行 | 0.5天 | ⏳ 待开发 |
| 🟢 低 | 任务互斥锁 | 防止同一定时任务并发执行（分布式锁） | 1天 | ⏳ 待开发 |

### 3. 审批流程

**场景：** 生产环境高危命令需要审批后才能执行

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| 🔴 高 | 命令风险等级 | 命令可设置风险等级（低/中/高/严重），高风险命令触发审批 | 1天 | ⏳ 待开发 |
| 🔴 高 | 审批工作流 | PENDING → APPROVED / REJECTED → EXECUTED 全流程 | 3天 | ⏳ 待开发 |
| 🟡 中 | 审批通知 | 钉钉/企业微信/邮件通知审批人 | 2天 | ⏳ 待开发 |
| 🟡 中 | 审批记录 | 完整的审批历史记录和审计追踪 | 1天 | ⏳ 待开发 |
| 🟢 低 | 紧急执行通道 | 特殊场景可跳过审批直接执行（需记录原因） | 1天 | ⏳ 待开发 |

### 4. 运维统计仪表盘

**场景：** 管理员需要全局视角了解命令执行趋势和系统健康状态

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| 🟡 中 | 执行统计概览 | 今日/本周/本月命令执行次数、成功率、平均耗时 | 2天 | ⏳ 待开发 |
| 🟡 中 | 趋势图表 | 命令执行趋势图、失败率变化曲线 | 2天 | ⏳ 待开发 |
| 🟡 中 | Top N 排行 | 最常执行的命令、最慢的命令、失败率最高的命令 | 1天 | ⏳ 待开发 |
| 🟢 低 | Token 使用分析 | 各 Token 的调用频率、最近活跃时间 | 1天 | ⏳ 待开发 |

### 5. 环境与主机管理

**场景：** 运维团队需要管理多个目标环境（开发/测试/预发/生产）和主机信息

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| 🟡 中 | 主机管理 | 集中管理 SSH 目标主机信息，避免命令中重复填写 | 3天 | ⏳ 待开发 |
| 🟡 中 | 环境分组 | 按开发/测试/预发/生产环境分组管理主机和命令 | 2天 | ⏳ 待开发 |
| 🟡 中 | 连接测试 | 一键测试主机 SSH 连接可达性 | 1天 | ⏳ 待开发 |
| 🟢 低 | 主机标签 | 主机支持标签分类（如按业务线、地域） | 1天 | ⏳ 待开发 |

---

## 🎯 长期架构演进（6-12个月）

> 面向规模化和企业级场景，实现集群部署、权限体系完善和生态集成。

### 1. 企业级权限体系

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| 🔴 高 | RBAC 增强 | 支持自定义角色和细粒度权限（命令级、主机级） | 5天 | ⏳ 待开发 |
| 🔴 高 | LDAP/AD 集成 | 对接企业 LDAP/ActiveDirectory 统一认证 | 3天 | ⏳ 待开发 |
| 🟡 中 | SSO 单点登录 | 支持 OAuth2/OIDC/SAML 协议的 SSO 登录 | 3天 | ⏳ 待开发 |
| 🟡 中 | 多租户（团队） | 支持团队隔离，不同团队管理各自的命令和主机 | 5天 | ⏳ 待开发 |
| 🟢 低 | 审计报告导出 | 按时间范围导出审计日志报告（PDF/Excel） | 2天 | ⏳ 待开发 |

### 2. 集群部署与高可用

**架构设计：**
```
       ┌─────────────┐
       │   Nginx     │
       └──────┬──────┘
          ┌───┴───┐
          ▼       ▼
    ┌─────────┐ ┌─────────┐
    │ Server1 │ │ Server2 │
    └────┬────┘ └────┬────┘
         │           │
         └─────┬─────┘
               ▼
         ┌──────────┐
         │  MySQL   │
         │  Redis   │
         └──────────┘
```

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| 🔴 高 | 无状态服务改造 | 确保所有状态外部化（Session/缓存→Redis） | 2天 | ⏳ 待开发 |
| 🔴 高 | 分布式锁 | 基于 Redis 的分布式锁，防止并发调度冲突 | 2天 | ⏳ 待开发 |
| 🟡 中 | Kubernetes 部署 | 提供 Helm Chart 和 K8s Deployment 模板 | 3天 | ⏳ 待开发 |
| 🟡 中 | 数据库高可用 | 支持 MySQL 主从复制配置和读写分离 | 3天 | ⏳ 待开发 |
| 🟢 低 | 水平扩展验证 | 多实例部署下的功能回归测试 | 2天 | ⏳ 待开发 |

### 3. 监控告警增强

**Prometheus 指标：**
```
# 命令执行指标
httprun_command_total{command,status}
httprun_command_duration_seconds{command}

# API 指标
httprun_api_requests_total{method,path,status}
httprun_api_duration_seconds{path}

# 系统指标
httprun_active_commands
httprun_ssh_pool_active{host}
httprun_token_count
```

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| 🟡 中 | 自定义告警规则 | 基于指标阈值配置告警（失败率、响应时间、并发数） | 3天 | ⏳ 待开发 |
| 🟡 中 | Grafana 仪表盘模板 | 提供开箱即用的 Grafana Dashboard JSON | 2天 | ⏳ 待开发 |
| 🟢 低 | 告警通知渠道 | 告警推送至钉钉/企业微信/PagerDuty 等 | 2天 | ⏳ 待开发 |


---

## 🔮 远期预留（12个月+，延期排后）

> 以下功能根据实际业务需求和社区反馈择时启动。

### Agent 模式

**场景：** 目标服务器无法 SSH，通过 Agent 执行命令

**架构：**
```
HttpRun Server ◄──WebSocket──► Agent (目标机器)
```

**核心功能：**
- Agent 心跳和状态监控
- Agent 分组管理
- 命令下发和结果回传
- Agent 在线/离线告警
- 简单的负载均衡（轮询）

> ⏸️ 状态：延期。当前 `AgentCommandExecutor` 已预留接口框架，待业务需求明确后启动开发。

### 插件系统

- 定义标准 SPI 插件接口（执行器插件、通知插件、认证插件）
- 插件热加载和生命周期管理
- 插件市场（社区贡献）

---

## 📝 技术债务清理

| 项目 | 说明 | 优先级 | 建议方案 | 状态 |
|------|------|--------|----------|------|
| AccessLog 表优化 | 数据量大时查询慢 | 🔴 高 | 按月分表或定期归档，配合索引优化 | ⏳ 待开发 |
| ~~SSH 连接每次新建~~ | ~~频繁连接同一主机开销大~~ | ✅ 已解决 | ~~引入 SSH 连接池（Commons Pool2）~~ | ✅ 已完成 |
| 服务层紧耦合 | 命令执行/日志/通知等逻辑耦合 | 🟡 中 | Spring ApplicationEvent 事件驱动解耦 | ⏳ 待开发 |
| API 无版本号 | 后续接口变更无法兼容 | 🟡 中 | 引入 `/api/v1/` 前缀 | ⏳ 待开发 |
| 缺少集成测试 | Controller 层缺少端到端测试 | 🟡 中 | MockMvc + TestContainers | ⏳ 待开发 |
| 前端缺少测试 | 组件测试少，回归风险高 | 🟢 低 | Jest + React Testing Library | ⏳ 待开发 |
| 前端 Bundle 优化 | 首屏加载较慢 | 🟢 低 | 路由懒加载、CDN、Tree Shaking | ⏳ 待开发 |
| ~~异步执行优化~~ | ~~长时间命令占用连接~~ | ✅ 已解决 | ~~WebSocket 实时输出~~ | ✅ 已完成 |

---

*本文档将随项目发展持续更新*
