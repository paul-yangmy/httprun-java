# HttpRun Java 项目发展规划

> 文档更新日期：2026年2月5日

## 📊 当前项目状态

### 已实现的核心功能

| 功能模块 | 状态 | 说明 |
|--------|------|------|
| 命令管理 | ✅ 已完成 | 创建、更新、删除、查询命令配置 |
| Token 认证 | ✅ 已完成 | 基于 JWT 的 API 访问控制 |
| 本地执行 | ✅ 已完成 | 在服务器本地执行 Shell 命令 |
| SSH 远程执行 | ✅ 已完成 | 通过 SSH 在远程服务器执行命令 |
| SSH 凭证加密 | ✅ 已完成 | AES-GCM 256位加密存储密码和私钥 |
| SSH 三级认证 | ✅ 已完成 | 指定私钥 > 系统默认密钥 > 密码认证 |
| 参数模板 | ✅ 已完成 | 支持 `{{.variable}}` 模板语法 |
| 访问日志 | ✅ 已完成 | 完整的命令执行日志记录，智能过滤查询请求 |
| 执行历史 | ✅ 已完成 | 服务端分页存储，支持多维度筛选和管理 |
| Web 管理界面 | ✅ 已完成 | React + Ant Design Pro 前端 |
| 实时输出 | ✅ 已完成 | WebSocket 实时推送命令执行输出 |

### 技术栈

**后端：**
- Java/17 (LTS)
- Spring Boot 3.2.x
- Spring Security 6.x + JWT
- Spring Data JPA + Hibernate
- 支持 SQLite / MySQL / H2 数据库

**前端：**
- React 18 + TypeScript
- Ant Design Pro + UmiJS
- Monaco Editor（代码编辑器）

---

## 🚀 短期优化建议（1-2个月）

### 1. 安全性增强

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| 🔴 高 | IP 白名单 | 限制命令只能从特定 IP 执行 | 2天 | ⏳ 待开发 |
| ✅ 完成 | 命令审计增强 | 记录执行者 IP、User-Agent、请求来源等 | 1天 | ✅ 已完成 |
| ✅ 完成 | 访问日志优化 | 过滤GET查询请求，只记录有意义的操作 | 1天 | ✅ 已完成 |
| ✅ 完成 | Token 权限细化 | 支持按命令授权和时间范围限制 | 2天 | ✅ 已完成 |
| ✅ 完成 | Token 管理优化 | 列表只显示未撤销Token，优化撤销流程 | 1天 | ✅ 已完成 |
| ✅ 完成 | 敏感参数脱敏 | 日志中隐藏密码类参数 | 1天 | ✅ 已完成 |
| ✅ 完成 | 操作二次确认 | 高危命令执行前二次确认（前端） | 1天 | ✅ 已完成 |
| ✅ 完成 | 命令注入防护 | 防止命令注入攻击，参数安全校验 | 2天 | ✅ 已完成 |

### 2. 执行体验优化

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| ✅ 完成 | 实时输出 | WebSocket 实时展示命令输出流 | 3天 | ✅ 已完成 |
| ✅ 完成 | 命令执行历史 | 服务端分页存储，支持多维度筛选、删除和管理 | 3天 | ✅ 已完成 |
| ✅ 完成 | 执行历史API | 查询、删除、批量删除、清空个人记录 | 2天 | ✅ 已完成 |
| ✅ 完成 | SSH 远程执行 | 通过 SSH 在远程服务器执行命令 | 3天 | ✅ 已完成 |
| ✅ 完成 | SSH 凭证加密 | AES-GCM 加密存储密码和私钥 | 2天 | ✅ 已完成 |
| ✅ 完成 | 命令收藏 | 收藏常用命令，快速访问 | 1天 | ✅ 已完成 |
| 🟢 低 | 暗黑模式 | 前端主题切换 | 1天 | ✅ 已完成 |

### 3. 代码质量

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| 🔴 高 | 单元测试 | 补充核心服务的测试用例，覆盖率 > 80% | 5天 | ✅ 已完成 |
| 🟡 中 | API 文档完善 | 优化 Swagger/OpenAPI 注释 | 2天 | ✅ 已完成 |
| 🟢 低 | 前端组件重构 | 优化组件复用性，减少重复代码 | 2天 | ✅ 已完成 |

---

## 📈 中期功能规划（3-6个月）

### 1. 简单命令编排

**场景：** 部署时需要按顺序执行多个命令（停服务 → 备份 → 部署 → 启动）

**功能设计：**
```yaml
# 简单的命令链
name: deploy-app
steps:
  - command: stop-service
    on_failure: abort
  
  - command: backup-db
    params:
      backup_name: "{{.date}}-backup"
  
  - command: deploy-code
  
  - command: start-service
    on_failure: rollback_to: backup-db
```

**核心功能：**
- ✅ 串行执行多个命令
- ✅ 并行执行（简单场景）
- ✅ 失败策略（中止/继续/回滚）
- ✅ 命令间参数传递
- ✅ 执行进度展示
- ✅ 可视化编排界面（简单流程图）

### 2. Agent 模式

**场景：** 目标服务器无法 SSH, 通过 Agent 执行命令

**架构：**
```
HttpRun Server ◄──WebSocket──► Agent (目标机器)
```

**核心功能：**
- ✅ Agent 心跳和状态监控
- ✅ Agent 分组管理
- ✅ 命令下发和结果回传
- ✅ Agent 在线/离线告警
- ✅ 简单的负载均衡（轮询）

### 3. 审批流程

**场景：** 生产环境高危命令需要审批

**核心功能：**
- ✅ 命令风险等级设置
- ✅ 指定审批人
- ✅ 审批通知（邮件/钉钉/企业微信）
- ✅ 审批历史记录
- ✅ 紧急执行通道

### 4. 定时任务

**场景：** 定期执行备份、巡检等命令

**核心功能：**
- ✅ Cron 表达式配置
- ✅ 可视化 Cron 编辑器
- ✅ 任务执行历史
- ✅ 失败告警
- ✅ 手动触发执行

---

## 🎯 长期架构演进（6-12个月）

### 1. 集群部署支持

**架构设计：**
```
       ┌─────────────┐
       │   Nginx     │
       └──────┬──────┘
          ┌───┴───┐
          ▼       ▼
    ┌─────────┐ ┌─────────┐
    │ Server1 │ │ Server2 │
    └────┬────┘ └────┬────┘
         │           │
         └─────┬─────┘
               ▼
         ┌──────────┐
         │  MySQL   │
         │  Redis   │
         └──────────┘
```

**核心功能：**
- ✅ 无状态服务设计
- ✅ Session 外部化（Redis）
- ✅ 数据库主从复制
- ✅ 负载均衡配置
- ✅ Docker/Kubernetes 部署

### 2. 监控告警

**Prometheus 指标：**
```
# 命令执行指标
httprun_command_total{command,status}
httprun_command_duration_seconds{command}

# API 指标
httprun_api_requests_total{method,path,status}
httprun_api_duration_seconds{path}

# 系统指标
httprun_active_commands
httprun_token_count
```

**告警规则：**
- 命令执行失败率 > 10%
- API 响应时间 P99 > 5s
- 服务不可用

### 3. 扩展工具

| 工具 | 说明 |
|------|------|
| **httprun-cli** | 命令行工具，便于终端使用 |
| **Jenkins 插件** | CI/CD 集成 |
| **GitLab CI 模板** | 自动化部署 |

---

## 📝 技术债务清理

| 项目 | 说明 | 优先级 | 建议方案 |
|------|------|--------|----------|
| AccessLog 表优化 | 数据量大时查询慢 | 🟡 中 | 按月分表或定期归档 |
| ~~异步执行优化~~ | ~~长时间命令占用连接~~ | ✅ 已解决 | ~~WebSocket 实时输出~~ |
| 前端 Bundle 优化 | 首屏加载较慢 | 🟢 低 | 路由懒加载、CDN |

---

*本文档将随项目发展持续更新*
