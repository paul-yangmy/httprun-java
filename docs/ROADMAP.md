# HttpRun Java 项目发展规划

> 文档生成日期：2026年2月1日

## 📊 当前项目状态

### 已实现的核心功能

| 功能模块 | 状态 | 说明 |
|----------|------|------|
| 命令管理 | ✅ 已完成 | 创建、更新、删除、查询命令配置 |
| Token 认证 | ✅ 已完成 | 基于 JWT 的 API 访问控制 |
| 本地执行 | ✅ 已完成 | 在服务器本地执行 Shell 命令 |
| SSH 远程执行 | ✅ 已完成 | 通过 SSH 在远程服务器执行命令 |
| 参数模板 | ✅ 已完成 | 支持 `{{.variable}}` 模板语法 |
| 访问日志 | ✅ 已完成 | 完整的命令执行日志记录 |
| Web 管理界面 | ✅ 已完成 | React + Ant Design Pro 前端 |

### 技术栈

**后端：**
- Java 17 (LTS)
- Spring Boot 3.2.x
- Spring Security 6.x + JWT
- Spring Data JPA + Hibernate
- 支持 SQLite / MySQL / H2 数据库

**前端：**
- React 18 + TypeScript
- Ant Design Pro + UmiJS
- Monaco Editor（代码编辑器）

---

## 🚀 短期优化建议（1-2个月）

### 1. 安全性增强

| 优先级 | 功能 | 说明 | 预估工时 | 状态 |
|--------|------|------|----------|------|
| 🔴 高 | IP 白名单 | 限制命令只能从特定 IP 执行 | 2天 | ⏳ 待开发 |
| ✅ 完成 | 命令审计增强 | 记录执行者 IP、User-Agent、请求来源等 | 1天 | ✅ 已完成 |
| 🟡 中 | Token 权限细化 | 支持按命令、按操作（读/写/执行）授权 | 3天 | ⏳ 待开发 |
| 🟡 中 | 敏感参数脱敏 | 日志中隐藏密码类参数 | 1天 | ⏳ 待开发 |
| 🟢 低 | 操作二次确认 | 高危命令执行前二次确认 | 1天 | ⏳ 待开发 |

### 2. 用户体验优化

| 优先级 | 功能 | 说明 | 预估工时 |
|--------|------|------|----------|
| 🔴 高 | 命令执行历史 | 在前端展示历史执行记录和结果 | 3天 |
| 🟡 中 | 命令收藏 | 用户收藏常用命令，快捷执行 | 2天 |
| 🟡 中 | 批量执行 | 支持多命令顺序/并行执行 | 3天 |
| 🟡 中 | 实时输出 | WebSocket 实时展示命令输出 | 3天 |
| 🟢 低 | 暗黑模式 | 前端主题切换 | 1天 |

### 3. 代码质量

| 优先级 | 功能 | 说明 | 预估工时 |
|--------|------|------|----------|
| 🔴 高 | 单元测试 | 补充核心服务的测试用例，覆盖率 > 80% | 5天 |
| 🟡 中 | API 文档完善 | 优化 Swagger/OpenAPI 注释 | 2天 |
| 🟢 低 | 前端组件重构 | 优化组件复用性，减少重复代码 | 2天 |

---

## 📈 中期功能规划（3-6个月）

### 1. 命令编排（Workflow）

**场景：** 部署流程需要依次执行多个命令，如：停止服务 → 备份 → 更新代码 → 启动服务

**功能设计：**
```yaml
# 示例：部署工作流
name: deploy-workflow
steps:
  - name: stop-service
    command: stop-app
    on_failure: abort
  
  - name: backup
    command: backup-db
    params:
      backup_name: "{{.date}}-backup"
  
  - name: update-code
    command: git-pull
    parallel: false
  
  - name: start-service
    command: start-app
    on_failure: rollback
```

**核心功能：**
- 定义命令执行流程（串行/并行）
- 条件分支（根据上一步结果决定下一步）
- 失败回滚策略
- 执行进度可视化
- 工作流模板管理

### 2. Agent 模式完善

**场景：** 目标服务器无法直接 SSH 访问，需要通过 Agent 中转执行

**功能设计：**
```
┌─────────────┐     HTTPS      ┌─────────────┐
│  HttpRun    │ ◄────────────► │   Agent     │
│  Server     │                │  (目标机器)  │
└─────────────┘                └─────────────┘
      │                              │
      │  WebSocket (心跳/任务下发)     │  本地执行
      └──────────────────────────────┘
```

**核心功能：**
- Agent 自动注册与心跳检测
- Agent 分组管理
- 多 Agent 负载均衡
- Agent 状态监控仪表盘
- 断线重连机制

### 3. 审批流程

**场景：** 生产环境的高危命令（如重启、删除）需要审批后执行

**功能设计：**
- 命令风险等级标记（低/中/高/极高）
- 审批人配置（支持多级审批）
- 审批通知集成（邮件/钉钉/企业微信/飞书）
- 审批历史与审计
- 紧急执行通道（需记录原因）

### 4. 定时任务

**场景：** 定期执行巡检、清理、备份等命令

**功能设计：**
- Cron 表达式配置
- 可视化 Cron 编辑器
- 任务执行历史
- 执行失败告警
- 任务依赖管理

---

## 🎯 长期架构演进（6-12个月）

### 1. 多租户支持

```
┌─────────────────────────────────────────┐
│              HttpRun SaaS               │
├─────────────────────────────────────────┤
│  租户A        │  租户B        │  租户C   │
│  - 命令空间   │  - 命令空间   │  - ...   │
│  - Token空间  │  - Token空间  │          │
│  - 独立配额   │  - 独立配额   │          │
└─────────────────────────────────────────┘
```

**核心功能：**
- 组织/团队数据隔离
- 资源配额管理
- 独立的 Token 命名空间
- 租户级别的配置管理

### 2. 高可用部署

**架构设计：**
```
                    ┌─────────────┐
                    │   Nginx     │
                    │   (LB)      │
                    └──────┬──────┘
           ┌───────────────┼───────────────┐
           ▼               ▼               ▼
    ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
    │  HttpRun-1  │ │  HttpRun-2  │ │  HttpRun-3  │
    └──────┬──────┘ └──────┬──────┘ └──────┬──────┘
           │               │               │
           └───────────────┼───────────────┘
                           ▼
              ┌─────────────────────────┐
              │   Redis Cluster         │
              │   (Session/Cache)       │
              └────────────┬────────────┘
                           │
              ┌─────────────────────────┐
              │   MySQL (主从)          │
              └─────────────────────────┘
```

**核心功能：**
- 无状态服务设计
- Redis Cluster 支持
- 数据库读写分离
- Kubernetes Helm Chart
- 健康检查与自动恢复

### 3. 生态扩展

| 工具 | 说明 | 价值 |
|------|------|------|
| httprun-cli | 命令行工具 | 方便 DevOps 在终端使用 |
| VS Code 插件 | IDE 集成 | 开发者友好 |
| Jenkins 插件 | CI/CD 集成 | 自动化流水线 |
| GitLab CI 模板 | CI/CD 集成 | 自动化部署 |
| Terraform Provider | IaC 支持 | 基础设施即代码 |

### 4. 监控告警

**Prometheus 指标：**
```
# 命令执行指标
httprun_command_execution_total{command="xxx", status="success|failed"}
httprun_command_execution_duration_seconds{command="xxx"}

# API 指标
httprun_api_requests_total{method="GET|POST", path="/xxx", status="2xx|4xx|5xx"}
httprun_api_request_duration_seconds{path="/xxx"}

# 系统指标
httprun_active_connections
httprun_token_count
httprun_command_count
```

**告警规则：**
- 命令执行失败率 > 10%
- API 响应时间 P99 > 5s
- 服务不可用告警
- Token 即将过期提醒

---

## 📝 技术债务清理

| 项目 | 说明 | 优先级 | 建议方案 |
|------|------|--------|----------|
| AccessLog 表优化 | 数据量大时性能下降 | 🟡 中 | 按月分表或归档策略 |
| 异步执行优化 | 长时间命令阻塞连接 | 🟡 中 | WebSocket 实时输出 |
| 配置外部化 | 敏感配置硬编码 | 🟢 低 | 集成 Nacos/Consul |
| 前端 Bundle 优化 | 首屏加载较慢 | 🟢 低 | 路由懒加载、CDN |
| 数据库连接池 | 高并发下连接不足 | 🟢 低 | HikariCP 参数调优 |

---

## 🗓️ 里程碑规划

### Phase 1：基础完善（2026年2月）

- [ ] 补充单元测试（覆盖率 > 70%）
- [ ] 完善 API 文档
- [ ] 添加命令执行历史页面
- [ ] IP 白名单功能

### Phase 2：体验优化（2026年3月）

- [ ] WebSocket 实时输出
- [ ] 命令批量执行
- [ ] Token 权限细化
- [ ] 命令收藏功能

### Phase 3：高级功能（2026年Q2）

- [ ] 命令编排（Workflow）
- [ ] 定时任务
- [ ] 审批流程（基础版）
- [ ] Agent 模式完善

### Phase 4：企业级特性（2026年Q3-Q4）

- [ ] 多租户支持
- [ ] 高可用架构
- [ ] 监控告警集成
- [ ] CLI 工具开发

---

## 📚 参考资源

- [Spring Boot 官方文档](https://docs.spring.io/spring-boot/docs/current/reference/html/)
- [Ant Design Pro 文档](https://pro.ant.design/zh-CN/docs/overview)
- [UmiJS 文档](https://umijs.org/docs/introduce/introduce)

---

*本文档将随项目发展持续更新*
